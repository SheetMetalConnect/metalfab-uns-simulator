<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Warehouse & Logistics - Eindhoven</title>
    <script src="https://unpkg.com/mqtt@5.3.5/dist/mqtt.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            background: #0a0e1a;
            color: #e4e7eb;
            padding: 20px;
        }

        .header {
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }

        h1 {
            font-size: 28px;
            font-weight: 600;
            color: #fff;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .subtitle {
            color: #9ca3af;
            font-size: 14px;
        }

        .connection-status {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            background: #7f1d1d;
            color: #fca5a5;
        }

        .connection-status.connected {
            background: #065f46;
            color: #6ee7b7;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: currentColor;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .refresh-btn {
            background: #3b82f6;
            color: white;
            border: none;
            border-radius: 6px;
            padding: 8px 16px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-left: 12px;
        }

        .refresh-btn:hover {
            background: #2563eb;
            transform: scale(1.05);
        }

        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 30px;
        }

        .summary-card {
            background: #1a1f2e;
            border: 1px solid #2d3548;
            border-radius: 8px;
            padding: 20px;
        }

        .summary-label {
            font-size: 12px;
            color: #9ca3af;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }

        .summary-value {
            font-size: 32px;
            font-weight: 600;
            color: #fff;
        }

        .summary-unit {
            font-size: 16px;
            color: #9ca3af;
            margin-left: 4px;
        }

        .section-title {
            font-size: 20px;
            font-weight: 600;
            color: #fff;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .section-subtitle {
            font-size: 14px;
            color: #9ca3af;
            font-weight: 400;
        }

        .agv-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(450px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }

        .agv-card {
            background: #1a1f2e;
            border: 1px solid #2d3548;
            border-radius: 12px;
            padding: 24px;
            transition: all 0.3s;
        }

        .agv-card:hover {
            border-color: #3b82f6;
            box-shadow: 0 4px 20px rgba(59, 130, 246, 0.2);
        }

        .agv-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 20px;
        }

        .agv-info {
            flex: 1;
        }

        .agv-name {
            font-size: 18px;
            font-weight: 600;
            color: #fff;
            margin-bottom: 4px;
        }

        .agv-model {
            font-size: 13px;
            color: #9ca3af;
        }

        .status-badge {
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .status-execute {
            background: #065f46;
            color: #6ee7b7;
        }

        .status-idle {
            background: #78350f;
            color: #fcd34d;
        }

        .status-stopped {
            background: #7f1d1d;
            color: #fca5a5;
        }

        .agv-visual {
            background: #0f1419;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            text-align: center;
        }

        .agv-icon {
            font-size: 64px;
            margin-bottom: 12px;
        }

        .agv-state {
            font-size: 14px;
            color: #9ca3af;
            margin-bottom: 4px;
        }

        .agv-job {
            font-size: 16px;
            font-weight: 600;
            color: #fff;
        }

        .agv-metrics {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 20px;
        }

        .metric-box {
            background: #0f1419;
            border-radius: 6px;
            padding: 12px;
            text-align: center;
        }

        .metric-label {
            font-size: 11px;
            color: #9ca3af;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
        }

        .metric-value {
            font-size: 24px;
            font-weight: 600;
            color: #fff;
        }

        .job-details {
            background: #0f1419;
            border-radius: 6px;
            padding: 16px;
            margin-bottom: 16px;
        }

        .job-row {
            display: flex;
            justify-content: space-between;
            padding: 6px 0;
            border-bottom: 1px solid #1a1f2e;
            font-size: 13px;
        }

        .job-row:last-child {
            border-bottom: none;
        }

        .job-label {
            color: #9ca3af;
        }

        .job-value {
            color: #fff;
            font-weight: 600;
        }

        .oee-section {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
        }

        .oee-item {
            text-align: center;
        }

        .oee-label {
            font-size: 10px;
            color: #9ca3af;
            text-transform: uppercase;
            margin-bottom: 4px;
        }

        .oee-value {
            font-size: 18px;
            font-weight: 600;
        }

        .oee-good {
            color: #6ee7b7;
        }

        .oee-medium {
            color: #fcd34d;
        }

        .oee-low {
            color: #fca5a5;
        }

        .inventory-section {
            margin-bottom: 40px;
        }

        .warehouse-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 16px;
            margin-bottom: 20px;
        }

        .warehouse-card {
            background: #1a1f2e;
            border: 1px solid #2d3548;
            border-radius: 8px;
            padding: 20px;
        }

        .warehouse-name {
            font-size: 16px;
            font-weight: 600;
            color: #fff;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .inventory-table {
            width: 100%;
        }

        .inventory-row {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 1fr;
            gap: 12px;
            padding: 10px 0;
            border-bottom: 1px solid #0f1419;
            font-size: 13px;
        }

        .inventory-row:last-child {
            border-bottom: none;
        }

        .inventory-header {
            font-weight: 600;
            color: #9ca3af;
            text-transform: uppercase;
            font-size: 11px;
            letter-spacing: 0.5px;
        }

        .material-name {
            color: #fff;
            font-weight: 600;
        }

        .material-desc {
            color: #9ca3af;
            font-size: 11px;
        }

        .qty-available {
            color: #6ee7b7;
            font-weight: 600;
        }

        .qty-reserved {
            color: #fcd34d;
            font-weight: 600;
        }

        .qty-ordered {
            color: #60a5fa;
            font-weight: 600;
        }

        .stock-bar {
            width: 100%;
            height: 6px;
            background: #0f1419;
            border-radius: 3px;
            overflow: hidden;
            margin-top: 4px;
        }

        .stock-fill {
            height: 100%;
            background: linear-gradient(90deg, #10b981, #059669);
            transition: width 0.3s;
        }

        .stock-low {
            background: linear-gradient(90deg, #f59e0b, #d97706);
        }

        .stock-critical {
            background: linear-gradient(90deg, #ef4444, #dc2626);
        }
    </style>
</head>
<body>
    <div class="header">
        <div>
            <h1>üì¶ Warehouse & Logistics</h1>
            <div class="subtitle">
                Eindhoven Warehouse Operations ‚Ä¢ Updated: <span id="timestamp"></span>
                <button class="refresh-btn" onclick="location.reload()">üîÑ Refresh</button>
            </div>
        </div>
        <div id="connectionStatus" class="connection-status">
            <span class="status-dot"></span>
            Connecting...
        </div>
    </div>

    <div class="summary-cards">
        <div class="summary-card">
            <div class="summary-label">AGV Fleet</div>
            <div class="summary-value">2<span class="summary-unit">units</span></div>
        </div>
        <div class="summary-card">
            <div class="summary-label">Active AGVs</div>
            <div class="summary-value" id="activeAgvs">0<span class="summary-unit"></span></div>
        </div>
        <div class="summary-card">
            <div class="summary-label">Material Types</div>
            <div class="summary-value" id="materialTypes">7<span class="summary-unit"></span></div>
        </div>
        <div class="summary-card">
            <div class="summary-label">Total Stock</div>
            <div class="summary-value" id="totalStock">0<span class="summary-unit">sheets</span></div>
        </div>
    </div>

    <div class="section-title">
        ü§ñ Automated Guided Vehicles
        <span class="section-subtitle">‚Ä¢ Fleet Status</span>
    </div>

    <div class="agv-grid" id="agvContainer"></div>

    <div class="inventory-section">
        <div class="section-title">
            üìä Material Inventory
            <span class="section-subtitle">‚Ä¢ Current Stock Levels</span>
        </div>

        <div class="warehouse-grid" id="inventoryContainer"></div>
    </div>

    <script>
        const MQTT_BROKER = 'ws://localhost:8083/mqtt';
        const SITE = 'eindhoven';
        const TOPIC_BASE = `umh/v1/metalfab/${SITE}`;

        let client = null;
        let agvData = {};
        let inventoryData = {};
        let messageCount = 0;

        // State mapping
        const STATE_MAP = {
            0: 'STOPPED', 1: 'STARTING', 2: 'IDLE', 3: 'EXECUTE',
            4: 'COMPLETING', 5: 'HELD', 6: 'SUSPENDED', 7: 'ABORTED'
        };

        // Connect to MQTT
        function connectMQTT() {
            console.log('Connecting to MQTT:', MQTT_BROKER);

            client = mqtt.connect(MQTT_BROKER, {
                reconnectPeriod: 1000,
                connectTimeout: 30000
            });

            client.on('connect', () => {
                console.log('Connected to MQTT');
                updateConnectionStatus(true);

                // Subscribe to warehouse topics
                const topics = [
                    `${TOPIC_BASE}/warehouse/+/Dashboard/#`,
                    `${TOPIC_BASE}/warehouse/+/Line/State`,
                    `${TOPIC_BASE}/ERP/Inventory/#`
                ];

                topics.forEach(topic => {
                    client.subscribe(topic, (err) => {
                        if (!err) console.log('Subscribed:', topic);
                    });
                });
            });

            client.on('message', handleMessage);
            client.on('error', () => updateConnectionStatus(false));
            client.on('offline', () => updateConnectionStatus(false));
        }

        // Handle incoming messages
        function handleMessage(topic, message) {
            if (!topic.startsWith(TOPIC_BASE)) return;

            messageCount++;
            const parts = topic.split('/');
            const payload = message.toString();

            try {
                // Handle AGV data
                if (topic.includes('/warehouse/')) {
                    const agvId = parts[5];
                    const namespace = parts[6];
                    const dataType = parts[7];

                    if (!agvData[agvId]) {
                        agvData[agvId] = {
                            id: agvId,
                            name: agvId.replace(/_/g, ' ').toUpperCase(),
                            state: 'STOPPED',
                            asset: {},
                            job: {},
                            oee: {}
                        };
                    }

                    if (namespace === 'Dashboard') {
                        if (dataType === 'Asset') agvData[agvId].asset = JSON.parse(payload);
                        else if (dataType === 'Job') agvData[agvId].job = JSON.parse(payload);
                        else if (dataType === 'OEE') agvData[agvId].oee = JSON.parse(payload);
                    } else if (namespace === 'Line' && dataType === 'State') {
                        agvData[agvId].state = STATE_MAP[parseInt(payload)] || 'UNKNOWN';
                    }

                    renderAGVs();
                    updateSummary();
                }

                // Handle inventory data
                if (topic.includes('/ERP/Inventory/')) {
                    const itemKey = parts[6]; // Get the item number (e.g., "S355")
                    inventoryData[itemKey] = JSON.parse(payload);
                    renderInventory();
                }

            } catch (e) {
                console.error('Error parsing message:', e);
            }
        }

        // Render AGV cards
        function renderAGVs() {
            const container = document.getElementById('agvContainer');
            container.innerHTML = '';

            Object.values(agvData).forEach(agv => {
                const card = createAGVCard(agv);
                container.appendChild(card);
            });
        }

        // Create AGV card
        function createAGVCard(agv) {
            const card = document.createElement('div');
            card.className = 'agv-card';

            const statusClass = agv.state === 'EXECUTE' ? 'status-execute' :
                               agv.state === 'IDLE' ? 'status-idle' : 'status-stopped';

            const hasJob = agv.job && agv.job.JobID;
            const oee = agv.oee || {};

            card.innerHTML = `
                <div class="agv-header">
                    <div class="agv-info">
                        <div class="agv-name">${agv.name}</div>
                        <div class="agv-model">${agv.asset.OEM || 'Jungheinrich EKS 215a'} ‚Ä¢ SN${agv.asset.AssetID || 'N/A'}</div>
                    </div>
                    <div class="status-badge ${statusClass}">${agv.state}</div>
                </div>

                <div class="agv-visual">
                    <div class="agv-icon">üöõ</div>
                    <div class="agv-state">State: ${agv.state}</div>
                    <div class="agv-job">${hasJob ? agv.job.JobID : 'No Active Job'}</div>
                </div>

                <div class="agv-metrics">
                    <div class="metric-box">
                        <div class="metric-label">Infeed</div>
                        <div class="metric-value">${agv.job?.PartsCompleted || 0}</div>
                    </div>
                    <div class="metric-box">
                        <div class="metric-label">Outfeed</div>
                        <div class="metric-value">${agv.job?.PartsTotal || 0}</div>
                    </div>
                </div>

                ${hasJob ? `
                    <div class="job-details">
                        <div class="job-row">
                            <span class="job-label">Customer</span>
                            <span class="job-value">${agv.job.Customer || 'N/A'}</span>
                        </div>
                        <div class="job-row">
                            <span class="job-label">Product</span>
                            <span class="job-value">${agv.job.ProductName || 'N/A'}</span>
                        </div>
                        <div class="job-row">
                            <span class="job-label">Priority</span>
                            <span class="job-value">${agv.job.Priority || 'NORMAL'}</span>
                        </div>
                    </div>
                ` : `
                    <div class="job-details">
                        <div class="job-row">
                            <span class="job-label">Status</span>
                            <span class="job-value">Ready for Assignment</span>
                        </div>
                    </div>
                `}

                <div class="oee-section">
                    <div class="oee-item">
                        <div class="oee-label">OEE</div>
                        <div class="oee-value ${getOEEClass(oee.OEE)}">${formatPercent(oee.OEE)}</div>
                    </div>
                    <div class="oee-item">
                        <div class="oee-label">Avail</div>
                        <div class="oee-value ${getOEEClass(oee.Availability)}">${formatPercent(oee.Availability)}</div>
                    </div>
                    <div class="oee-item">
                        <div class="oee-label">Perf</div>
                        <div class="oee-value ${getOEEClass(oee.Performance)}">${formatPercent(oee.Performance)}</div>
                    </div>
                    <div class="oee-item">
                        <div class="oee-label">Quality</div>
                        <div class="oee-value ${getOEEClass(oee.Quality)}">${formatPercent(oee.Quality)}</div>
                    </div>
                </div>
            `;

            return card;
        }

        // Render inventory
        function renderInventory() {
            const container = document.getElementById('inventoryContainer');
            const materials = Object.entries(inventoryData).filter(([key]) =>
                !key.includes('summary') && !key.includes('raw_materials')
            );

            // Group by warehouse (mock data - you'd need this in your UNS)
            const warehouses = {
                'A': materials.slice(0, 2),
                'B': materials.slice(2, 5),
                'C': materials.slice(5)
            };

            container.innerHTML = '';
            let totalStock = 0;

            Object.entries(warehouses).forEach(([warehouse, items]) => {
                const card = document.createElement('div');
                card.className = 'warehouse-card';

                let itemsHTML = items.map(([key, data]) => {
                    const available = data.available_quantity || 0;
                    const reserved = data.reserved_quantity || 0;
                    const ordered = data.ordered_quantity || 0;
                    const total = available + reserved + ordered;
                    const fillPercent = total > 0 ? (available / total * 100) : 0;
                    const fillClass = fillPercent < 30 ? 'stock-critical' : fillPercent < 50 ? 'stock-low' : '';

                    totalStock += available;

                    return `
                        <div class="inventory-row">
                            <div>
                                <div class="material-name">${data.item_number || key}</div>
                                <div class="material-desc">${data.item_description || ''}</div>
                                <div class="stock-bar">
                                    <div class="stock-fill ${fillClass}" style="width: ${fillPercent}%"></div>
                                </div>
                            </div>
                            <div class="qty-available">${available}</div>
                            <div class="qty-reserved">${reserved}</div>
                            <div class="qty-ordered">${ordered}</div>
                        </div>
                    `;
                }).join('');

                card.innerHTML = `
                    <div class="warehouse-name">üìç Warehouse ${warehouse}</div>
                    <div class="inventory-table">
                        <div class="inventory-row inventory-header">
                            <div>Material</div>
                            <div>Available</div>
                            <div>Reserved</div>
                            <div>Ordered</div>
                        </div>
                        ${itemsHTML}
                    </div>
                `;

                container.appendChild(card);
            });

            document.getElementById('totalStock').innerHTML = `${totalStock}<span class="summary-unit">sheets</span>`;
            document.getElementById('materialTypes').innerHTML = `${materials.length}<span class="summary-unit"></span>`;
        }

        // Update summary
        function updateSummary() {
            const activeCount = Object.values(agvData).filter(agv => agv.state === 'EXECUTE').length;
            document.getElementById('activeAgvs').innerHTML = `${activeCount}<span class="summary-unit"></span>`;
        }

        // Helper functions
        function getOEEClass(value) {
            if (!value) return 'oee-low';
            if (value >= 0.85) return 'oee-good';
            if (value >= 0.70) return 'oee-medium';
            return 'oee-low';
        }

        function formatPercent(value) {
            return value ? `${Math.round(value * 100)}%` : '--';
        }

        function updateConnectionStatus(connected) {
            const status = document.getElementById('connectionStatus');
            status.className = `connection-status ${connected ? 'connected' : ''}`;
            status.innerHTML = `<span class="status-dot"></span>${connected ? 'Connected' : 'Disconnected'}`;
        }

        function updateTimestamp() {
            document.getElementById('timestamp').textContent = new Date().toLocaleTimeString();
        }

        // Initialize
        updateTimestamp();
        setInterval(updateTimestamp, 1000);
        connectMQTT();
    </script>
</body>
</html>
