<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MetalFab Eindhoven - Factory Overview</title>
    <script src="https://unpkg.com/mqtt@5.3.5/dist/mqtt.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #0f172a 100%);
            min-height: 100vh;
            color: #e2e8f0;
            position: relative;
            overflow-x: hidden;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background-image:
                linear-gradient(rgba(59, 130, 246, 0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(59, 130, 246, 0.03) 1px, transparent 1px);
            background-size: 50px 50px;
            z-index: 0;
            pointer-events: none;
        }

        /* Breadcrumb */
        .breadcrumb {
            background: #0f172a;
            border-bottom: 1px solid #1e293b;
            padding: 8px 24px;
            font-size: 13px;
            color: #94a3b8;
            position: relative;
            z-index: 60;
        }
        .breadcrumb a {
            color: #60a5fa;
            text-decoration: none;
        }
        .breadcrumb a:hover {
            color: #93c5fd;
            text-decoration: underline;
        }

        /* Glass effects */
        .glass {
            background: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
        }
        .glass-light {
            background: rgba(30, 41, 59, 0.5);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.08);
        }

        /* Header */
        .header {
            position: sticky;
            top: 0;
            z-index: 50;
        }
        .header-inner {
            max-width: 1400px;
            margin: 0 auto;
            padding: 16px 24px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .header-left {
            display: flex;
            align-items: center;
            gap: 16px;
        }
        .header-title {
            font-size: 28px;
            font-weight: 700;
            background: linear-gradient(135deg, #60a5fa, #67e8f9);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .header-subtitle {
            color: #94a3b8;
            font-size: 13px;
            margin-top: 2px;
        }
        .connection-box {
            padding: 10px 16px;
            border-radius: 8px;
        }
        .conn-row {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .conn-dot {
            width: 10px; height: 10px;
            border-radius: 50%;
            background: #6b7280;
        }
        .conn-dot.on { background: #10b981; }
        .conn-text { font-size: 13px; font-weight: 500; }
        .conn-detail { font-size: 11px; color: #94a3b8; }

        /* Content */
        .content {
            max-width: 1400px;
            margin: 0 auto;
            padding: 24px;
            position: relative;
            z-index: 10;
        }

        /* Stat cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 16px;
            margin-bottom: 32px;
        }
        .stat-card {
            border-radius: 16px;
            padding: 20px;
            position: relative;
            overflow: hidden;
        }
        .stat-card-top {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }
        .stat-label {
            font-size: 13px;
            color: #94a3b8;
            font-weight: 500;
        }
        .stat-value {
            font-size: 36px;
            font-weight: 700;
        }
        .stat-value.blue {
            background: linear-gradient(135deg, #60a5fa, #67e8f9);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .stat-value.green { color: #10b981; }
        .stat-value.yellow { color: #fbbf24; }
        .stat-value.teal {
            background: linear-gradient(135deg, #34d399, #67e8f9);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .stat-sub { font-size: 11px; color: #64748b; margin-top: 4px; }
        .sparkline-container { height: 40px; position: relative; }

        /* Departments */
        .dept-section {
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 24px;
        }
        .dept-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
        }
        .dept-title {
            font-size: 20px;
            font-weight: 700;
            text-transform: capitalize;
            background: linear-gradient(135deg, #60a5fa, #67e8f9);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .dept-count {
            font-size: 13px;
            color: #64748b;
            font-weight: 400;
        }
        .dept-link {
            margin-left: auto;
            font-size: 12px;
            color: #60a5fa;
            text-decoration: none;
            padding: 4px 12px;
            border: 1px solid rgba(96, 165, 250, 0.3);
            border-radius: 6px;
        }
        .dept-link:hover {
            background: rgba(96, 165, 250, 0.1);
            border-color: rgba(96, 165, 250, 0.5);
        }
        .machines-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(420px, 1fr));
            gap: 16px;
        }

        /* Machine cards */
        .machine-card {
            border-radius: 12px;
            padding: 20px;
            border: 2px solid transparent;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
            text-decoration: none;
            color: inherit;
            display: block;
        }
        .machine-card:hover {
            transform: translateY(-4px) scale(1.01);
            box-shadow: 0 20px 60px -15px rgba(0, 0, 0, 0.6);
        }
        .state-execute {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.2), rgba(5, 150, 105, 0.1));
            border-color: rgba(16, 185, 129, 0.4);
        }
        .state-idle {
            background: linear-gradient(135deg, rgba(251, 191, 36, 0.2), rgba(245, 158, 11, 0.1));
            border-color: rgba(251, 191, 36, 0.4);
        }
        .state-stopped {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.2), rgba(220, 38, 38, 0.1));
            border-color: rgba(239, 68, 68, 0.4);
        }
        .state-held {
            background: linear-gradient(135deg, rgba(249, 115, 22, 0.2), rgba(234, 88, 12, 0.1));
            border-color: rgba(249, 115, 22, 0.4);
        }

        .card-top {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 16px;
        }
        .card-machine-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .machine-icon {
            width: 44px; height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 10px;
            font-size: 13px;
            font-weight: 700;
            color: #93c5fd;
            background: rgba(59, 130, 246, 0.15);
            border: 1px solid rgba(59, 130, 246, 0.25);
            letter-spacing: -0.5px;
        }
        .card-machine-name {
            font-size: 16px;
            font-weight: 700;
            color: #fff;
        }
        .card-machine-oem {
            font-size: 11px;
            color: #94a3b8;
            margin-top: 2px;
        }
        .card-state-col {
            text-align: right;
        }
        .card-state-name {
            font-size: 15px;
            font-weight: 700;
        }
        .card-state-time {
            font-size: 11px;
            color: #94a3b8;
        }
        .card-stop-reason {
            font-size: 11px;
            color: #f59e0b;
            margin-top: 2px;
        }

        /* State text colors */
        .text-green { color: #10b981; }
        .text-yellow { color: #fbbf24; }
        .text-red { color: #ef4444; }
        .text-orange { color: #f97316; }
        .text-purple { color: #a78bfa; }
        .text-gray { color: #94a3b8; }

        /* Job box */
        .job-box {
            border-radius: 8px;
            padding: 14px;
            margin-bottom: 14px;
        }
        .job-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        .job-label {
            font-size: 10px;
            font-weight: 700;
            letter-spacing: 1px;
            color: #94a3b8;
            text-transform: uppercase;
        }
        .priority-badge {
            font-size: 10px;
            font-weight: 600;
            padding: 2px 10px;
            border-radius: 10px;
            color: #fff;
        }
        .priority-URGENT { background: rgba(239, 68, 68, 0.8); }
        .priority-HIGH { background: rgba(249, 115, 22, 0.8); }
        .priority-NORMAL { background: rgba(59, 130, 246, 0.8); }
        .priority-LOW { background: rgba(107, 114, 128, 0.8); }
        .job-id {
            font-family: 'Monaco', 'Courier New', monospace;
            font-size: 15px;
            font-weight: 700;
            color: #fff;
            margin-bottom: 2px;
        }
        .job-customer {
            font-size: 13px;
            color: #cbd5e1;
        }
        .job-product {
            font-size: 11px;
            color: #94a3b8;
        }
        .no-job {
            text-align: center;
            color: #64748b;
            padding: 8px 0;
        }

        /* Progress bar */
        .progress-wrapper { margin-top: 10px; }
        .progress-top {
            display: flex;
            justify-content: space-between;
            font-size: 11px;
            margin-bottom: 4px;
        }
        .progress-track {
            width: 100%;
            height: 6px;
            background: rgba(51, 65, 85, 0.5);
            border-radius: 3px;
            overflow: hidden;
        }
        .progress-fill {
            height: 100%;
            border-radius: 3px;
            background: linear-gradient(90deg, #10b981, #059669, #047857);
            box-shadow: 0 0 12px rgba(16, 185, 129, 0.4);
            transition: width 0.5s ease-out;
        }

        /* OEE row */
        .oee-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
        }
        .oee-cell {
            text-align: center;
            border-radius: 8px;
            padding: 8px 4px;
        }
        .oee-cell-label {
            font-size: 10px;
            color: #94a3b8;
            margin-bottom: 2px;
        }
        .oee-cell-value {
            font-size: 18px;
            font-weight: 700;
        }

        /* Skeleton */
        @keyframes skeleton-loading {
            0% { background-position: -200px 0; }
            100% { background-position: calc(200px + 100%) 0; }
        }
        .skeleton {
            background: linear-gradient(90deg, rgba(255,255,255,0.05) 25%, rgba(255,255,255,0.1) 37%, rgba(255,255,255,0.05) 63%);
            background-size: 400px 100%;
            animation: skeleton-loading 1.4s ease infinite;
            border-radius: 8px;
        }

        /* Pulse animation */
        @keyframes pulse-glow {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .status-pulse { animation: pulse-glow 2s ease-in-out infinite; }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: rgba(15, 23, 42, 0.5); }
        ::-webkit-scrollbar-thumb { background: rgba(59, 130, 246, 0.5); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: rgba(59, 130, 246, 0.7); }

        @media (max-width: 900px) {
            .stats-grid { grid-template-columns: repeat(2, 1fr); }
            .machines-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <!-- Breadcrumb -->
    <div class="breadcrumb">
        <a href="index.html">&larr; Dashboards</a> &nbsp;|&nbsp; Factory Overview
    </div>

    <!-- Header -->
    <div class="header glass">
        <div class="header-inner">
            <div class="header-left">
                <div>
                    <div class="header-title">MetalFab Eindhoven</div>
                    <div class="header-subtitle">Factory Overview</div>
                </div>
            </div>
            <div class="connection-box glass-light">
                <div class="conn-row">
                    <div class="conn-dot" id="connectionDot"></div>
                    <div>
                        <div class="conn-text" id="connectionText">Connecting...</div>
                        <div class="conn-detail">
                            <span id="messageCount">0</span> msgs &middot;
                            <span id="lastUpdate">--:--:--</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="content">
        <!-- Stat cards -->
        <div class="stats-grid">
            <div class="glass stat-card">
                <div class="stat-card-top">
                    <div class="stat-label">Total Assets</div>
                </div>
                <div class="stat-value blue" id="totalAssets">0</div>
                <div class="stat-sub">Active machines</div>
            </div>
            <div class="glass stat-card">
                <div class="stat-card-top">
                    <div class="stat-label">Running</div>
                </div>
                <div class="stat-value green" id="runningCount">0</div>
                <div class="sparkline-container">
                    <canvas id="runningSparkline"></canvas>
                </div>
            </div>
            <div class="glass stat-card">
                <div class="stat-card-top">
                    <div class="stat-label">Idle</div>
                </div>
                <div class="stat-value yellow" id="idleCount">0</div>
                <div class="stat-sub">Waiting for work</div>
            </div>
            <div class="glass stat-card">
                <div class="stat-card-top">
                    <div class="stat-label">Avg OEE</div>
                </div>
                <div class="stat-value teal" id="avgOEE">0%</div>
                <div class="sparkline-container">
                    <canvas id="oeeSparkline"></canvas>
                </div>
            </div>
        </div>

        <!-- Departments -->
        <div id="departments">
            <!-- Loading skeleton -->
            <div class="glass dept-section">
                <div class="skeleton" style="height: 28px; width: 200px; margin-bottom: 20px;"></div>
                <div class="machines-grid">
                    <div class="skeleton" style="height: 260px;"></div>
                    <div class="skeleton" style="height: 260px;"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const MQTT_BROKER = 'ws://localhost:8083/mqtt';
        const SITE = 'eindhoven';
        const TOPIC_BASE = `umh/v1/metalfab/${SITE}`;

        // State
        let machines = {};
        let messageCount = 0;
        let client = null;
        let runningHistory = [];
        let oeeHistory = [];
        let runningChart = null;
        let oeeChart = null;

        // Machine icon abbreviations (no emojis)
        const MACHINE_ABBR = {
            'laser': 'LAS',
            'press': 'PRS',
            'weld': 'WLD',
            'coating': 'COT',
            'agv': 'AGV',
            'saw': 'SAW',
        };

        // Department links
        const DEPT_LINKS = {
            'finishing': { href: 'coating_line_dashboard.html', label: 'Coating Line' },
            'warehouse': { href: 'warehouse_dashboard.html', label: 'Warehouse' },
        };

        // PackML State â†’ CSS class
        const STATE_CLASSES = {
            'STOPPED': 'state-stopped',
            'IDLE': 'state-idle',
            'STARTING': 'glass-light',
            'EXECUTE': 'state-execute',
            'COMPLETING': 'glass-light',
            'HELD': 'state-held',
            'SUSPENDED': 'glass-light',
            'ABORTED': 'state-stopped',
        };

        // Initialize
        window.addEventListener('load', () => {
            initCharts();
            connectMQTT();
            startPeriodicUpdates();
        });

        // Sparkline charts
        function initCharts() {
            const chartConfig = {
                type: 'line',
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { display: false },
                        y: { display: false, beginAtZero: true }
                    },
                    elements: {
                        line: { tension: 0.4 },
                        point: { radius: 0 }
                    }
                }
            };

            runningChart = new Chart(document.getElementById('runningSparkline').getContext('2d'), {
                ...chartConfig,
                data: {
                    labels: Array(20).fill(''),
                    datasets: [{
                        data: Array(20).fill(0),
                        borderColor: 'rgba(16, 185, 129, 0.8)',
                        backgroundColor: 'rgba(16, 185, 129, 0.2)',
                        fill: true,
                        borderWidth: 2
                    }]
                }
            });

            oeeChart = new Chart(document.getElementById('oeeSparkline').getContext('2d'), {
                ...chartConfig,
                data: {
                    labels: Array(20).fill(''),
                    datasets: [{
                        data: Array(20).fill(0),
                        borderColor: 'rgba(52, 211, 153, 0.8)',
                        backgroundColor: 'rgba(52, 211, 153, 0.2)',
                        fill: true,
                        borderWidth: 2
                    }]
                },
                options: {
                    ...chartConfig.options,
                    scales: {
                        ...chartConfig.options.scales,
                        y: { display: false, beginAtZero: true, max: 100 }
                    }
                }
            });
        }

        function updateSparklines() {
            const running = Object.values(machines).filter(m => m.state === 'EXECUTE').length;
            runningHistory.push(running);
            if (runningHistory.length > 20) runningHistory.shift();

            const oeeValues = Object.values(machines)
                .map(m => m.oee && m.oee.OEE ? m.oee.OEE * 100 : 0)
                .filter(v => v > 0);
            const avgOEE = oeeValues.length > 0
                ? oeeValues.reduce((a, b) => a + b, 0) / oeeValues.length
                : 0;
            oeeHistory.push(avgOEE);
            if (oeeHistory.length > 20) oeeHistory.shift();

            runningChart.data.datasets[0].data = runningHistory;
            runningChart.update('none');
            oeeChart.data.datasets[0].data = oeeHistory;
            oeeChart.update('none');
        }

        // MQTT Connection
        function connectMQTT() {
            client = mqtt.connect(MQTT_BROKER, {
                reconnectPeriod: 1000,
                connectTimeout: 30000
            });

            client.on('connect', () => {
                updateConnectionStatus(true);

                const topics = [
                    `${TOPIC_BASE}/+/+/Dashboard/#`,
                    `${TOPIC_BASE}/+/+/Line/State`,
                    `${TOPIC_BASE}/+/+/Edge/StateName`,
                    `${TOPIC_BASE}/+/+/Edge/StopReason`,
                ];

                topics.forEach(topic => {
                    client.subscribe(topic);
                });
            });

            client.on('message', handleMessage);
            client.on('error', () => updateConnectionStatus(false));
            client.on('offline', () => updateConnectionStatus(false));
        }

        // Handle MQTT messages
        function handleMessage(topic, message) {
            if (!topic.startsWith(TOPIC_BASE)) return;

            messageCount++;
            document.getElementById('messageCount').textContent = messageCount;
            document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString();

            const parts = topic.split('/');
            if (parts.length < 7) return;

            const dept = parts[4];
            const machine = parts[5];
            const namespace = parts[6];
            const dataType = parts[7];
            const machineKey = `${dept}/${machine}`;

            if (!machines[machineKey]) {
                machines[machineKey] = {
                    id: machine,
                    name: machine.replace(/_/g, ' ').toUpperCase(),
                    department: dept,
                    state: 'UNKNOWN',
                    stateSince: Date.now(),
                    asset: {},
                    job: {},
                    oee: {},
                    stopReason: null,
                    lastUpdate: Date.now()
                };
            }

            let data;
            try {
                data = JSON.parse(message.toString());
            } catch (e) {
                data = message.toString();
            }

            if (namespace === 'Dashboard') {
                if (dataType === 'Asset') machines[machineKey].asset = data;
                else if (dataType === 'Job') machines[machineKey].job = data;
                else if (dataType === 'OEE') machines[machineKey].oee = data;
            } else if (namespace === 'Line' && dataType === 'State') {
                const newState = getStateName(data);
                if (machines[machineKey].state !== newState) {
                    machines[machineKey].state = newState;
                    machines[machineKey].stateSince = Date.now();
                }
            } else if (namespace === 'Edge' && dataType === 'StateName') {
                const newState = data.toString();
                if (machines[machineKey].state !== newState) {
                    machines[machineKey].state = newState;
                    machines[machineKey].stateSince = Date.now();
                }
            } else if (namespace === 'Edge' && dataType === 'StopReason') {
                if (data && data.code) {
                    machines[machineKey].stopReason = data;
                } else {
                    machines[machineKey].stopReason = null;
                }
            }

            machines[machineKey].lastUpdate = Date.now();

            const shouldUpdate = namespace === 'Dashboard' ||
                                (namespace === 'Line' && dataType === 'State') ||
                                (namespace === 'Edge');

            if (shouldUpdate) {
                requestAnimationFrame(updateUI);
            }
        }

        function getStateName(stateNum) {
            const states = {
                0: 'STOPPED', 1: 'STARTING', 2: 'IDLE', 3: 'EXECUTE',
                4: 'COMPLETING', 5: 'HELD', 6: 'SUSPENDED', 7: 'ABORTED'
            };
            return states[stateNum] || 'UNKNOWN';
        }

        function getMachineAbbr(machineId) {
            const id = machineId.toLowerCase();
            for (const [key, abbr] of Object.entries(MACHINE_ABBR)) {
                if (id.includes(key)) return abbr;
            }
            return 'MCH';
        }

        // Render state (for change detection)
        function getRenderState(machine) {
            return {
                state: machine.state,
                jobId: machine.job?.JobID,
                jobProgress: machine.job?.Progress,
                jobPriority: machine.job?.Priority,
                oee: machine.oee?.OEE,
                availability: machine.oee?.Availability,
                quality: machine.oee?.Quality,
                performance: machine.oee?.Performance,
                assetOEM: machine.asset?.OEM,
                assetModel: machine.asset?.Model,
                stopCode: machine.stopReason?.code,
            };
        }

        // Debounced UI update
        let updateScheduled = false;
        let lastMachineStates = {};

        function updateUI() {
            if (updateScheduled) return;
            updateScheduled = true;

            setTimeout(() => {
                let hasChanges = false;
                Object.keys(machines).forEach(key => {
                    const currentState = getRenderState(machines[key]);
                    const lastState = lastMachineStates[key];
                    if (!lastState || JSON.stringify(currentState) !== JSON.stringify(lastState)) {
                        hasChanges = true;
                        lastMachineStates[key] = currentState;
                    }
                });

                if (hasChanges) {
                    renderDashboard();
                    updateStatistics();
                    updateSparklines();
                }
                updateScheduled = false;
            }, 100);
        }

        // Render dashboard
        let lastDepartmentStructure = null;

        function renderDashboard() {
            const departments = {};
            Object.values(machines).forEach(machine => {
                if (!departments[machine.department]) {
                    departments[machine.department] = [];
                }
                departments[machine.department].push(machine);
            });

            const container = document.getElementById('departments');
            const currentStructure = Object.keys(departments).sort().join(',');

            if (currentStructure !== lastDepartmentStructure) {
                container.innerHTML = '';
                Object.keys(departments).sort().forEach(dept => {
                    const deptDiv = document.createElement('div');
                    deptDiv.className = 'glass dept-section';
                    deptDiv.dataset.department = dept;
                    const deptMachines = departments[dept];
                    const link = DEPT_LINKS[dept];
                    const linkHtml = link
                        ? `<a class="dept-link" href="${link.href}">${link.label} &rarr;</a>`
                        : '';

                    deptDiv.innerHTML = `
                        <div class="dept-header">
                            <span class="dept-title">${dept} Department</span>
                            <span class="dept-count">${deptMachines.length} machines</span>
                            ${linkHtml}
                        </div>
                        <div class="machines-grid" data-machines-container="${dept}">
                            ${deptMachines.map(m => renderMachineCard(m)).join('')}
                        </div>
                    `;
                    container.appendChild(deptDiv);
                });
                lastDepartmentStructure = currentStructure;
            } else {
                Object.keys(departments).sort().forEach(dept => {
                    const mc = container.querySelector(`[data-machines-container="${dept}"]`);
                    if (mc) {
                        mc.innerHTML = departments[dept].map(m => renderMachineCard(m)).join('');
                    }
                });
            }
        }

        // Machine card
        function renderMachineCard(machine) {
            const stateClass = STATE_CLASSES[machine.state] || 'glass-light';
            const timeSince = formatTimeSince(machine.stateSince);
            const hasJob = machine.job && machine.job.JobID;
            const oeePercent = machine.oee && machine.oee.OEE ? Math.round(machine.oee.OEE * 100) : 0;
            const abbr = getMachineAbbr(machine.id);
            const machineKey = `${machine.department}/${machine.id}`;
            const oeeUrl = `oee-dashboard.html?machine=${encodeURIComponent(machineKey)}`;

            // Stop reason display (only when not EXECUTE)
            let stopHtml = '';
            if (machine.state !== 'EXECUTE' && machine.stopReason && machine.stopReason.code) {
                stopHtml = `<div class="card-stop-reason">${machine.stopReason.code} &middot; ${machine.stopReason.name}</div>`;
            }

            const priority = machine.job?.Priority || 'NORMAL';

            return `
                <a href="${oeeUrl}" class="machine-card glass-light ${stateClass}">
                    <div class="card-top">
                        <div class="card-machine-info">
                            <div class="machine-icon">${abbr}</div>
                            <div>
                                <div class="card-machine-name">${machine.name}</div>
                                <div class="card-machine-oem">
                                    ${machine.asset.OEM || 'Unknown'} ${machine.asset.Model || ''}
                                </div>
                            </div>
                        </div>
                        <div class="card-state-col">
                            <div class="card-state-name ${getStateColor(machine.state)}">${machine.state}</div>
                            <div class="card-state-time" data-state-timestamp="${machine.stateSince}">${timeSince}</div>
                            ${stopHtml}
                        </div>
                    </div>

                    ${hasJob ? `
                        <div class="job-box glass">
                            <div class="job-header">
                                <span class="job-label">Current Job</span>
                                <span class="priority-badge priority-${priority}">${priority}</span>
                            </div>
                            <div class="job-id">${machine.job.JobID}</div>
                            <div class="job-customer">${machine.job.Customer || 'Unknown'}</div>
                            <div class="job-product">${machine.job.ProductName || ''}</div>
                            ${machine.job.Progress !== undefined ? `
                                <div class="progress-wrapper">
                                    <div class="progress-top">
                                        <span style="color: #94a3b8;">Progress</span>
                                        <span style="font-weight: 700;">${machine.job.Progress}%</span>
                                    </div>
                                    <div class="progress-track">
                                        <div class="progress-fill" style="width: ${machine.job.Progress}%"></div>
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                    ` : `
                        <div class="job-box glass no-job">No active job</div>
                    `}

                    <div class="oee-grid">
                        <div class="oee-cell glass">
                            <div class="oee-cell-label">OEE</div>
                            <div class="oee-cell-value" style="color: ${getOEEHex(oeePercent)}">${oeePercent}%</div>
                        </div>
                        <div class="oee-cell glass">
                            <div class="oee-cell-label">Avail</div>
                            <div class="oee-cell-value">${machine.oee.Availability ? Math.round(machine.oee.Availability * 100) : 0}%</div>
                        </div>
                        <div class="oee-cell glass">
                            <div class="oee-cell-label">Qual</div>
                            <div class="oee-cell-value">${machine.oee.Quality ? Math.round(machine.oee.Quality * 100) : 0}%</div>
                        </div>
                        <div class="oee-cell glass">
                            <div class="oee-cell-label">Perf</div>
                            <div class="oee-cell-value">${machine.oee.Performance ? Math.round(machine.oee.Performance * 100) : 0}%</div>
                        </div>
                    </div>
                </a>
            `;
        }

        // Helpers
        function getStateColor(state) {
            const colors = {
                'EXECUTE': 'text-green', 'IDLE': 'text-yellow', 'STOPPED': 'text-red',
                'HELD': 'text-orange', 'SUSPENDED': 'text-purple', 'ABORTED': 'text-red'
            };
            return colors[state] || 'text-gray';
        }

        function getOEEHex(oee) {
            if (oee >= 85) return '#10b981';
            if (oee >= 70) return '#fbbf24';
            return '#ef4444';
        }

        function formatTimeSince(timestamp) {
            const seconds = Math.floor((Date.now() - timestamp) / 1000);
            if (seconds < 60) return `${seconds}s`;
            if (seconds < 3600) return `${Math.floor(seconds / 60)}m`;
            const hours = Math.floor(seconds / 3600);
            const mins = Math.floor((seconds % 3600) / 60);
            return `${hours}h ${mins}m`;
        }

        function updateStatistics() {
            const total = Object.keys(machines).length;
            const running = Object.values(machines).filter(m => m.state === 'EXECUTE').length;
            const idle = Object.values(machines).filter(m => m.state === 'IDLE').length;

            const oeeValues = Object.values(machines)
                .map(m => m.oee && m.oee.OEE ? m.oee.OEE : 0)
                .filter(v => v > 0);
            const avgOEE = oeeValues.length > 0
                ? Math.round((oeeValues.reduce((a, b) => a + b, 0) / oeeValues.length) * 100)
                : 0;

            document.getElementById('totalAssets').textContent = total;
            document.getElementById('runningCount').textContent = running;
            document.getElementById('idleCount').textContent = idle;
            document.getElementById('avgOEE').textContent = avgOEE + '%';
        }

        function updateConnectionStatus(connected) {
            const dot = document.getElementById('connectionDot');
            const text = document.getElementById('connectionText');
            if (connected) {
                dot.className = 'conn-dot on status-pulse';
                text.textContent = 'Connected';
                text.style.color = '#10b981';
            } else {
                dot.className = 'conn-dot status-pulse';
                dot.style.background = '#ef4444';
                text.textContent = 'Disconnected';
                text.style.color = '#ef4444';
            }
        }

        function startPeriodicUpdates() {
            setInterval(() => {
                const stateTimestamps = document.querySelectorAll('[data-state-timestamp]');
                stateTimestamps.forEach(el => {
                    const timestamp = parseInt(el.dataset.stateTimestamp);
                    el.textContent = formatTimeSince(timestamp);
                });
            }, 1000);
        }
    </script>
</body>
</html>
